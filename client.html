<meta charset="utf-8">
<script src="/socket/SocketConnection.js" name="Socket"></script>
<script src="https://code.jquery.com/jquery-1.11.3.js"></script>
<script src="https://cdn.jsdelivr.net/jquery.cookie/1.4.1/jquery.cookie.js"></script>
<style>
  fieldset {
    border: 1px solid #99FF33;
  }
  fieldset:after {
    content: '.';
    display: block;
    height: 0;
    overflow: hidden;
    clear: both;
  }

  label {
    display: block;
  }
  input {
    width: 500px;
  }

  #display, #all-msg {
    height: 500px;
    width: 48%;
    overflow: scroll;
    border: 1px solid #EEE;
    margin-top: 5px;
  }
  #display {
    float: left;
  }
  #all-msg {
    float: right;
  }

  p.msg {
    margin: 0.3em;
    padding: 0.3em;
    background: #99FF33;
    border-radius: 10px;
    position: relative;;
  }
  p.msg span {
    font-size: 8px;
    color: #FFF;
    position: absolute;
    top: 0; right: 10px;
  }
</style>

<fieldset>
  <legend>connect server</legend>
  <label><input id="socket-url" placeholder="socket server url"></label>
  <button id="connection"></button>
</fieldset>

<fieldset>
  <legend>listen channel</legend>
  <input id="channel-in" placeholder="channel_name">
  <button id="listen"></button>
  <div id="display"></div>
  <div id="all-msg"></div>
</fieldset>

<fieldset>
  <legend>send</legend>
  <input id="channel-out" placeholder="channel:message...">
  <button id="send">發送</button>
</fieldset>

<script>

  (function(
          $inp_socket_url, $btn_conn,
          $inp_chan_in, $btn_listen, $display, $all_msg,
          $inp_chan_out, $btn_send){

    var socket, listening;

    $('input')
      .on('blur', function(){
        var $self = $(this),
            name = $self.attr('id'),
            val = $self.val();
        $.cookie(name, val);
      }).each(function(){
        var $self = $(this),
            val = $.cookie($self.attr('id'));

            val && $self.val(val);
      });

    $btn_conn.on('click', function(){
      if (socket) {
        listening && $btn_listen.click();
        socket.close();
        socket = null;

        $btn_conn.text('connect');

      } else {

        socket = Socket.connect($inp_socket_url.val());
        $all_msg.empty();

        socket.on('message', function (e) {
          $all_msg.append('<p class="msg">'+JSON.stringify(e.data)+'<span>'+(new Date).toLocaleString()+'</span></p>').animate({scrollTop: $all_msg.get(0).scrollHeight}, 300);
        });

        $btn_conn.text('disconnect');
      }

    }).text('connect');

    $btn_listen.on('click', function(){
      if ( ! socket) {
        alert('尚未建立連線!!');
        return;
      }

      if (listening) {
        socket.unlisten(listening);
        listening = null;
        $btn_listen.text('listen');
        $inp_chan_in.removeAttr('readonly');
      } else {
        $inp_chan_in.attr('readonly', 'readonly');
        listening = $inp_chan_in.val();
        $display.empty();
        socket.listen(listening, function(data){
          $display.append('<p class="msg">'+JSON.stringify(data)+'<span>'+(new Date).toLocaleString()+'</span></p>').animate({scrollTop: $display.get(0).scrollHeight}, 300);
        });
        $btn_listen.text('unlisten');
      }
      
    }).text('listen');



    $btn_send.on('click', function(){
      if ( ! socket) {
        alert('尚未建立連線!!');
        return;
      }

      socket.emit($inp_chan_out.val());
      $inp_chan_out.val('');

    });

      $inp_chan_out.on('keypress', function(e){
          e.keyCode === 13 && $btn_send.click();
      });

  })(

    $('#socket-url'),
    $('#connection'),

    $('#channel-in'),
    $('#listen'),
    $('#display'),
    $('#all-msg'),

    $('#channel-out'),
    $('#send')
  );

</script>


