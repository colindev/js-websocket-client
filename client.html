<meta charset="utf-8">
<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
<script src="https://code.jquery.com/jquery-1.11.3.js"></script>
<script src="//cdn.jsdelivr.net/jquery.cookie/1.4.1/jquery.cookie.js"></script>
<style>
  label {
    display: block;
  }
  input {
    width: 500px;
  }

  #display {
    height: 500px;
    overflow: scroll;
    border: 1px solid #EEE;
    margin-top: 5px;
  }
  p.msg {
    margin: 0.3em;
    padding: 0.3em;
    background: #99FF33;
    border-radius: 10px;
  }
</style>

<fieldset>
  <legend>connect server</legend>
  <label><input id="socket-url" placeholder="socket server url"></label>
  <label><input id="socket-path" placeholder="socket server path"></label>
  <button id="connection"></button>
</fieldset>

<fieldset>
  <legend>listen channel</legend>
  <input id="channel-in" placeholder="channel_name">
  <button id="listen"></button>
  <div id="display"></div>

</fieldset>

<fieldset>
  <legend>send</legend>
  <input id="channel-out" placeholder="channel:message...">
  <button id="send">發送</button>
</fieldset>

<script>

  (function(
          $inp_socket_url, $inp_socket_path, $btn_conn, 
          $inp_chan_in, $btn_listen, $display,
          $inp_chan_out, $btn_send,
          $source_link){

    var socket, listening;

    $('input')
      .on('blur', function(){
        var $self = $(this),
            name = $self.attr('id'),
            val = $self.val();
        $.cookie(name, val);
      }).each(function(){
        var $self = $(this),
            val = $.cookie($self.attr('id'));

            val && $self.val(val);
      });

    $btn_conn.on('click', function(){
      if (socket) {
        listening && $btn_listen.click();
        socket.disconnect();
        
        socket = null;
        $btn_conn.text('connect');

      } else {

        socket = io($inp_socket_url.val(), {
          path: $inp_socket_path.val()
        }).connect();

        $btn_conn.text('disconnect');
      }

      $inp_socket_url.val().replace(/:(\d+)$/, function(m, $1){
        $source_link.attr('href', $source_link.attr('href').replace(/\{port\}/, $1));
      });
    }).text('connect');

    $btn_listen.on('click', function(){
      if ( ! socket) {
        alert('尚未建立連線!!');
        return;
      }

      if (listening) {
        socket.off(listening);
        listening = null;
        $btn_listen.text('listen');
        $inp_chan_in.removeAttr('readonly');
      } else {
        $inp_chan_in.attr('readonly', 'readonly');
        listening = $inp_chan_in.val();
        socket.on(listening, function(data){
          $display.append('<p class="msg">'+JSON.stringify(data)+'</p>').animate({scrollTop: $display.get(0).scrollHeight}, 300);
        });
        $btn_listen.text('unlisten');
      }
      
    }).text('listen');

    $btn_send.on('click', function(){
      if ( ! socket) {
        alert('尚未建立連線!!');
        return;
      }
      $inp_chan_out.val().replace(/^([^:]+):([^\$]+)$/, function(m, $1, $2){
        socket.emit($1, $2);
      });
    });
      
      $inp_chan_out.on('keypress', function(e){
          e.keyCode === 13 && $btn_send.click();
      });

  })(

    $('#socket-url'),
    $('#socket-path'),
    $('#connection'),

    $('#channel-in'),
    $('#listen'),
    $('#display'),

    $('#channel-out'),
    $('#send'),

    $('#source-link')
  );

</script>


